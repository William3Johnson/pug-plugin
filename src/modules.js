const { merge } = require('webpack-merge');
const { plugin } = require('./utils');
const ansis = require('ansis');

/**
 * The lightweight plugin module to extract and save the HTML file.
 *
 * Note: you can use this module as boilerplate for your own custom module.
 *
 * @param {ModuleOptions} options The custom options.
 * @return {ModuleOptions} Default options merged with custom options.
 */
const extractHtml = (options = {}) => {
  const defaultOptions = {
    test: /\.(html)$/,
    enabled: true,
    verbose: false,
    sourcePath: undefined,
    outputPath: undefined,
    filename: '[name].html',
    // example of filename as the function
    //filename: (pathData, assetInfo) => {
    //  const name = pathData.chunk.name;
    //  return name === 'main' ? 'index.html' : '[name].html';
    //},

    /**
     * @param {string} content The extracted html.
     * @param {EntryAssetInfo} info
     * @param {Compilation} compilation
     * @return {string | null}
     */
    //postprocess: (content, info, compilation) => {
    //  // todo For example, pretty format the content of html.
    //  if (info.verbose) console.log(`Extract HTML: ${info.entryFile}\n`);
    //  return content;
    //},
  };

  return merge(defaultOptions, options);
};

/**
 * The lightweight plugin module to extract the css from asset content.
 * todo test cases:
 *   - add supports a chunk name template with [id]
 *   - https://github.com/webpack-contrib/mini-css-extract-plugin/tree/master/test/manual/src
 *   - multiple entries, https://github.com/webpack-contrib/mini-css-extract-plugin/blob/master/test/cases/at-import-in-the-entry/webpack.config.js
 *
 * @param {ModuleOptions} options The custom options.
 * @return {ModuleOptions} Default options merged with custom options.
 */
const extractCss = (options = {}) => {
  const defaultOptions = {
    test: /\.(css|sass|scss)$/,
    enabled: true,
    verbose: false,
    sourcePath: undefined,
    outputPath: undefined,
    filename: '[name].css',

    /**
     * @param {string} content The css content generated by css-loader.
     * @param {EntryAssetInfo} info
     * @param {Compilation} compilation
     * @return {string | null}
     */
    postprocess: (content, info, compilation) => {
      if (info.verbose) {
        console.log(
          ansis.black.bgYellow(`[${plugin}]`) + ansis.black.bgGreen(` Extract CSS `) + ansis.cyan(' ' + info.entryFile)
        );
      }
      return content;
    },
  };

  return merge(defaultOptions, options);
};

module.exports = {
  extractHtml,
  extractCss,
};
